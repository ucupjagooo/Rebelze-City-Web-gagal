<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Input - Daily RP Storyboard</title>
    <!-- Memuat Tailwind CSS dari CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL VARIABLES (Provided by Canvas Environment) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // --------------------------------------------------------

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId = null;
        let isAuthReady = false;

        // Function to handle authentication
        const setupAuth = async () => {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Auth Error:", error);
                document.getElementById('auth-status').innerHTML = '<span class="text-red-400">Error Auth! Cek Konsol.</span>';
            }

            onAuthStateChanged(auth, (user) => {
                const statusDiv = document.getElementById('auth-status');
                
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    
                    // Akses diberikan kepada siapa pun setelah berhasil autentikasi
                    statusDiv.innerHTML = `<span class="text-green-400 font-bold">SIAP!</span> User ID: ${userId.substring(0, 8)}...`;
                    
                    // TOMBOL TIDAK LAGI DIKENDALIKAN DI SINI, HANYA STATUS DIV
                    
                    console.log("Auth Ready. User ID:", userId);
                } else {
                    userId = null;
                    isAuthReady = true;
                    statusDiv.innerHTML = '<span class="text-yellow-400">Anonim/Logout.</span> Silakan coba lagi.';
                    
                    console.log("Signed out or Anonymous user.");
                }
            });
        };

        // Function to add a new post (exposed globally)
        window.addPost = async () => {
            if (!isAuthReady || !userId) {
                // Memberikan peringatan, namun user sudah bisa klik dari awal
                alertUser('error', 'Status Autentikasi BELUM SIAP. Mohon tunggu status SIAP! sebelum mengirim.');
                return;
            }

            const category = document.getElementById('category').value; 
            const imageUrl = document.getElementById('image-url').value.trim();
            const description = document.getElementById('description').value.trim();
            const form = document.getElementById('post-form');

            if (!imageUrl || !description || !category) {
                alertUser('error', 'Semua kolom wajib diisi, termasuk Kategori.');
                return;
            }

            try {
                // Path ke koleksi Storyboard
                const storyboardCollectionRef = collection(db, `artifacts/${appId}/public/data/storyboard_posts`);
                
                await addDoc(storyboardCollectionRef, {
                    imageUrl: imageUrl,
                    description: description,
                    type: category, // Simpan tipe (clan atau city)
                    timestamp: new Date(), 
                    addedBy: userId // Tetap menyimpan ID pengguna yang mengirim (untuk audit)
                });
                
                alertUser('success', `Aktivitas berhasil ditambahkan ke Storyboard ${category.toUpperCase()}!`);
                form.reset(); // Clear the form
            } catch (e) {
                console.error("Error adding document: ", e);
                // Pesan kesalahan yang lebih spesifik untuk membantu debugging
                alertUser('error', `Gagal menyimpan data! Cek Aturan Keamanan Firestore atau koneksi: ${e.message}`);
            }
        };
        
        // Custom Alert Function (replacing alert())
        const alertUser = (type, message) => {
            const alertDiv = document.getElementById('custom-alert');
            alertDiv.textContent = message;
            alertDiv.classList.remove('hidden', 'text-green-400', 'text-red-400', 'text-yellow-400');
            
            let colorClass = 'text-yellow-400'; 
            if (type === 'success') {
                colorClass = 'text-green-400';
            } else if (type === 'error') {
                colorClass = 'text-red-400';
            }

            alertDiv.classList.add(colorClass);
            alertDiv.classList.remove('hidden');
            
            setTimeout(() => {
                alertDiv.classList.add('hidden');
            }, 5000);
        }

        // Initialize App
        setupAuth();
    </script>
    
    <style>
        /* Mengatur font Inter dan tema gelap-ungu */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e; /* Hitam keunguan tua */
            color: #ffffff; /* Teks putih */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container-card {
            background-color: #2a094e; /* Ungu gelap untuk card */
            border: 2px solid #6c47ff; /* Border ungu terang */
        }
        .text-purple-highlight {
            color: #bd93f9; /* Ungu lavender untuk highlight */
        }
        .shadow-purple-heavy {
            box-shadow: 0 10px 15px -3px rgba(108, 71, 255, 0.3), 0 4px 6px -2px rgba(108, 71, 255, 0.1);
        }
        .input-style {
            background-color: #3e1f76;
            color: white;
            border: 1px solid #6c47ff;
            padding: 10px;
            border-radius: 6px;
        }
        .btn-submit {
            background-color: #a855f7;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.5);
            transition: all 0.3s;
        }
        .btn-submit:hover {
            background-color: #9333ea;
        }
        /* Kelas .btn-disabled dihapus */
    </style>
</head>
<body>

    <div class="w-full max-w-xl container-card rounded-xl p-6 sm:p-10 shadow-purple-heavy">

        <!-- Header Admin -->
        <header class="text-center mb-6">
            <h1 class="text-4xl font-extrabold text-purple-highlight tracking-wider uppercase mt-2">
                ADMIN INPUT STORYBOARD
            </h1>
            <p class="text-lg text-gray-400 mt-2">Pilih kategori untuk memisahkan postingan Clan dan Kota.</p>
             <!-- Status Autentikasi (Alat Diagnostik) -->
            <div id="auth-status" class="mt-4 text-sm text-center text-gray-400 p-2 border border-gray-700 rounded-lg">
                Menunggu Autentikasi...
            </div>
        </header>

        <!-- Form Input Konten Baru -->
        <section id="admin-form-section" class="p-6 bg-[#1e073a] rounded-xl border border-purple-highlight/50 shadow-inner">
            <h2 class="text-2xl font-bold text-purple-highlight mb-4 border-b border-gray-700 pb-2">
                Tambah Postingan Baru
            </h2>
            <form id="post-form" onsubmit="event.preventDefault(); addPost();" class="space-y-4">
                
                <!-- Kategori Pilihan -->
                <div>
                    <label for="category" class="block text-gray-300 mb-1 font-semibold">Kategori Storyboard (Wajib):</label>
                    <select id="category" class="input-style w-full" required>
                        <option value="">-- Pilih Kategori --</option>
                        <option value="clan">Aktivitas Clan (Internal)</option>
                        <option value="city">Aktivitas Kota (Random)</option>
                    </select>
                </div>

                <!-- URL Foto -->
                <div>
                    <label for="image-url" class="block text-gray-300 mb-1">URL Foto Aktivitas:</label>
                    <input type="url" id="image-url" class="input-style w-full" placeholder="Contoh: https://i.imgur.com/myphoto.jpg" required>
                    <p class="text-xs text-gray-400 mt-1">Pastikan URL gambar dapat diakses publik.</p>
                </div>

                <!-- Deskripsi -->
                <div>
                    <label for="description" class="block text-gray-300 mb-1">Deskripsi/Keterangan RP:</label>
                    <textarea id="description" class="input-style w-full h-20 resize-none" placeholder="Cth: Mike dan tim menguji senjata baru di range." required></textarea>
                </div>
                
                <p id="custom-alert" class="text-center mt-4 text-sm hidden"></p>

                <!-- Tombol HILANGKAN 'disabled' dan 'btn-disabled' -->
                <button id="post-submit-button" type="submit" class="btn-submit w-full py-3 text-white font-semibold rounded-lg shadow-md transition duration-200">
                    Posting ke Storyboard
                </button>
            </form>
        </section>
        
        <!-- Footer -->
        <footer class="mt-10 pt-4 border-t border-gray-700 text-center text-gray-400 text-sm">
            <p>Admin Panel | Data disimpan di Firestore koleksi 'storyboard_posts'.</p>
        </footer>
    </div>

</body>
</html>